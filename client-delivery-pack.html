<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Client Delivery Pack — SharePoint to iSPoC</title>
<style>
  :root { color-scheme: light only; }
  body { font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; color: #1b1f23; background: #fafafa; }
  .container { max-width: 1024px; margin: 0 auto; padding: 36px 24px 72px; }
  h1, h2, h3, h4 { margin: 18px 0 10px; line-height: 1.25; color: #000000; }
  p { line-height: 1.6; margin: 0 0 12px; }
  ul, ol { margin: 0 0 16px; padding-left: 22px; }
  .muted { color: #6b7280; font-size: 14px; }
  .card { border: 1px solid #e1e4e8; border-radius: 12px; padding: 24px; margin: 22px 0; background: #ffffff; box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04); }
  .toc h2 { margin-top: 0; }
  .toc ol { margin: 0; padding-left: 20px; }
  .toc a { color: #0f172a; text-decoration: none; }
  .toc li { margin: 6px 0; }
  .tagline { font-weight: 600; color: #0f172a; font-size: 18px; }
  .highlight { background: #ecfdf5; border: 1px solid #a7f3d0; padding: 14px 16px; border-radius: 8px; color: #065f46; margin: 16px 0; }
  .callout { background: #eef2ff; border: 1px solid #c7d2fe; padding: 14px 16px; border-radius: 8px; color: #3730a3; margin: 16px 0; }
  .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin: 16px 0; }
  .grid .mini-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; background: #f8fafc; }
  .code-block { position: relative; border: 1px solid #d1d5db; border-radius: 10px; background: #0b1021; margin: 18px 0; box-shadow: 0 1px 3px rgba(15, 23, 42, 0.16); }
  .code-block button { position: absolute; top: 10px; right: 10px; border: 1px solid #38bdf8; background: rgba(14, 165, 233, 0.12); color: #e0f2fe; border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer; }
  .code-block button:hover { background: rgba(14, 165, 233, 0.24); }
  .code-block pre { margin: 0; padding: 46px 18px 18px; color: #e6edf3; font-size: 13px; line-height: 1.5; overflow: auto; white-space: pre; }
  code.inline { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; font-size: 13px; }
  table { border-collapse: collapse; width: 100%; margin: 16px 0; }
  th, td { border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; vertical-align: top; }
  th { background: #f9fafb; font-weight: 600; }
  .step-list { counter-reset: step; list-style: none; padding-left: 0; }
  .step-list li { counter-increment: step; margin-bottom: 16px; padding-left: 46px; position: relative; }
  .step-list li::before { content: counter(step); position: absolute; left: 0; top: 0; width: 32px; height: 32px; border-radius: 50%; background: #0f172a; color: #fff; display: grid; place-items: center; font-size: 14px; font-weight: 600; }
  .download-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top: 12px; }
  .btn { display: inline-block; padding: 10px 14px; border-radius: 8px; text-decoration: none; text-align: center; border: 1px solid #e5e7eb; background: #f8fafc; color: #0f172a; font-weight: 600; }
  .btn:hover { background: #eef2ff; }
  .btn-primary { border-color: #2563eb; background: #2563eb; color: #ffffff; }
  .btn-primary:hover { background: #1d4ed8; }
  .flow { width: 100%; max-width: 960px; margin: 8px 0 4px; }
</style>
<script>
  function copyCode(button) {
    const wrapper = button.closest('.code-block');
    if (!wrapper) return;
    const pre = wrapper.querySelector('pre');
    if (!pre) return;
    const text = pre.innerText.trim();
    navigator.clipboard.writeText(text).then(() => {
      const original = button.textContent;
      button.textContent = 'Copied';
      setTimeout(() => { button.textContent = original; }, 2000);
    });
  }
</script>
</head>
<body>
  <div class="container">
    <h1>iSPoC: Document Processing & Automation Pipeline</h1>

    <div class="card toc">
      <h2>Contents</h2>
      <ol>
        <li><a href="#objective">Objective and Purpose</a></li>
        <li><a href="#tools">Tools needed</a></li>
        <li><a href="#requirements">Requirements</a></li>
        <li><a href="#workflow">Automated Workflow (triggers, steps and scripts)</a></li>
        <li><a href="#testing">Testing</a></li>
        <li><a href="#next-steps">Next steps (switch to live vector store)</a></li>
      </ol>
    </div>

    <div id="objective" class="card">
      <h2>Objective and Purpose</h2>
      <p class="tagline">Enable staff to get instant, accurate answers from current policies and guides in iSPoC.</p>
      <div class="highlight">Purpose of this project: Automate the flow from SharePoint to iSPoC so staff always have access to the latest policy information without manual updates.</div>
    </div>


    <div id="tools" class="card">
      <h2>Tools needed</h2>
      <div class="grid">
        <div class="mini-card"><h4>SharePoint</h4><p>One folder to watch (e.g. <code class="inline">/Policies/Live</code>).</p></div>
        <div class="mini-card"><h4>Power Automate</h4><p>Monitors SharePoint and starts the Azure job.</p></div>
        <div class="mini-card"><h4>Azure Container Apps</h4><p>Runs the processing job.</p></div>
        <div class="mini-card"><h4>OpenAI (vector store)</h4><p>Updates the vector store used by iSPoC.</p></div>
      </div>
    </div>

    <div id="requirements" class="card">
      <h2>Requirements</h2>
      <ul>
        <li>SharePoint site and library access.</li>
        <li>Power Automate environment with HTTP action.</li>
        <li>Azure subscription and resource group.</li>
        <li>OpenAI API key and vector store IDs (test and live).</li>
      </ul>
      <div class="callout"><strong>Security:</strong> use managed identity for the HTTP action; keep keys in the Container Apps job secrets.</div>
      
      <h3>Environment Variables</h3>
      <p>Set these environment variables in your Azure Container Apps job secrets for testing:</p>
      <div class="code-block">
        <button onclick="copyCode(this)">Copy</button>
        <pre># OpenAI Configuration
VITE_OPENAI_API_KEY=your_openai_api_key_here
OPENAI_API_KEY=your_openai_api_key_here

# Vector Store ID (Test Environment)
TEST_VECTOR_STORE_ID=your_test_vector_store_id_here</pre>
      </div>
      <p class="muted"><strong>Note:</strong> Replace the placeholder values with your actual keys and IDs. Never commit these values to version control.</p>
    </div>

    <div id="workflow" class="card">
      <h2>Automated Workflow (triggers, steps and scripts)</h2>
      <p class="muted">Follow the diagram, then use the buttons to download scripts.</p>

      <svg class="flow" viewBox="0 0 960 560" xmlns="http://www.w3.org/2000/svg" aria-label="SharePoint to iSPoC flow">
        <defs>
          <linearGradient id="boxgrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#ffffff" />
            <stop offset="100%" stop-color="#f8fafc" />
          </linearGradient>
          <filter id="ds" x="-10%" y="-10%" width="120%" height="120%">
            <feDropShadow dx="0" dy="1" stdDeviation="1.2" flood-color="#0f172a" flood-opacity="0.12" />
          </filter>
          <marker id="arrow" markerWidth="12" markerHeight="12" refX="8" refY="3.5" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,7 L10,3.5 z" fill="#334155" />
          </marker>
          <style>
            .box { fill: url(#boxgrad); stroke: #334155; stroke-width: 1.2; rx: 10; filter: url(#ds); }
            .label { font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; font-size: 13px; fill: #0f172a; }
            .mutelabel { font-size: 12px; fill: #64748b; }
            .flowline { stroke: #334155; stroke-width: 1.6; fill: none; }
          </style>
        </defs>
        <!-- Layout constants: centerX=480, boxW=440, boxH=70 -->
        <rect class="box" x="260" y="20" width="440" height="70" />
        <text class="label" x="480" y="52" text-anchor="middle">SharePoint</text>
        <text class="mutelabel" x="480" y="70" text-anchor="middle">Folder change</text>

        <rect class="box" x="260" y="120" width="440" height="70" />
        <text class="label" x="480" y="152" text-anchor="middle">Power Automate</text>
        <text class="mutelabel" x="480" y="170" text-anchor="middle">Trigger + HTTP call</text>

        <rect class="box" x="260" y="220" width="440" height="70" />
        <text class="label" x="480" y="252" text-anchor="middle">Azure Container Apps</text>
        <text class="mutelabel" x="480" y="270" text-anchor="middle">Policy processing job</text>

        <rect class="box" x="260" y="320" width="440" height="90" />
        <text class="label" x="480" y="350" text-anchor="middle">Scripts</text>
        <text class="mutelabel" text-anchor="middle">
          <tspan x="480" y="368">convert → index → validate → AI Qs</tspan>
          <tspan x="480" dy="16">combine → validate → upsert → reconcile</tspan>
        </text>

        <rect class="box" x="260" y="440" width="440" height="70" />
        <text class="label" x="480" y="472" text-anchor="middle">iSPoC Tool</text>
        <text class="mutelabel" x="480" y="490" text-anchor="middle">Uses vector store</text>

        <!-- Vertical arrows between boxes -->
        <line class="flowline" x1="480" y1="90" x2="480" y2="120" marker-end="url(#arrow)" />
        <line class="flowline" x1="480" y1="190" x2="480" y2="220" marker-end="url(#arrow)" />
        <line class="flowline" x1="480" y1="290" x2="480" y2="320" marker-end="url(#arrow)" />
        <line class="flowline" x1="480" y1="410" x2="480" y2="440" marker-end="url(#arrow)" />
        <text class="mutelabel" x="492" y="430">upsert to vector store</text>
      </svg>

      <h3>Triggers and steps</h3>
      <ol>
        <li>SharePoint: file added or modified in the chosen folder (.docx).</li>
        <li>Power Automate: trigger → get file content → HTTP POST to start the job.</li>
        <li>Container job runs these scripts in order:
          <ol>
            <li><code class="inline">scripts/convert_to_json.py</code> — convert policies (.docx → JSON)</li>
            <li><code class="inline">scripts/convert_guides_to_json.py</code> — convert guides</li>
            <li><code class="inline">scripts/build_policy_index.py</code> — build policy index</li>
            <li><code class="inline">scripts/build_guide_index.py</code> — build guides index</li>
            <li><code class="inline">scripts/validate_outputs.py</code> — validate JSON (initial)</li>
            <li><code class="inline">scripts/generate_ai_questions.py</code> — generate policy AI Q&A</li>
            <li><code class="inline">scripts/generate_guide_ai_questions.py</code> — generate guide AI Q&A</li>
            <li><code class="inline">scripts/combine_indexes.py</code> — combine policy + guide indexes</li>
            <li><code class="inline">scripts/validate_outputs.py</code> — validate JSON (final)</li>
            <li><code class="inline">scripts/vector_store_upsert.py</code> — upsert to the vector store</li>
            <li><code class="inline">scripts/reconcile_vector_store.py</code> — reconcile deleted/changed files</li>
          </ol>
        </li>
        <li>iSPoC reflects updates automatically because it reads from the vector store at query time.</li>
      </ol>

      <div class="callout">
        <strong>Idempotency:</strong> The pipeline uses content hashing to skip unchanged files. Only modified, added, or deleted files trigger processing. This means the pipeline won't re-process all files on every trigger — just the ones that actually changed.
      </div>

      <div class="highlight">
        <strong>Download:</strong> Use the full ZIP to get all pipeline scripts and dependencies.
        <div class="download-grid" style="margin-top:12px;">
          <a class="btn btn-primary" href="/client-pipeline.zip" download>Download full pipeline (ZIP)</a>
        </div>
        <p class="muted" style="margin-top:10px;">The ZIP contains <code class="inline">run_pipeline.py</code> and the entire <code class="inline">scripts/</code> folder. <code class="inline">run_pipeline.py</code> is the orchestrator and requires the scripts to be present.</p>
      </div>

      <h3>Dependencies</h3>
      <p>The pipeline requires the following Python packages. Create a <code class="inline">requirements.txt</code> file with these exact versions:</p>
      <div class="code-block">
        <button onclick="copyCode(this)">Copy</button>
        <pre>python-docx==0.8.11
openai==1.44.0
python-dotenv>=1.0.1
jsonschema>=4.21.1
httpx==0.27.0</pre>
      </div>
      <p class="muted">Install with: <code class="inline">pip install -r requirements.txt</code></p>

      <h3>Power Automate HTTP call</h3>
      <ul>
        <li>Method: <strong>POST</strong></li>
        <li>URL: <code class="inline">https://management.azure.com/subscriptions/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/&lt;RG_NAME&gt;/providers/Microsoft.App/jobs/&lt;JOB_NAME&gt;/start?api-version=2023-05-01</code></li>
        <li>Body includes: <code class="inline">fileName</code>, <code class="inline">filePath</code>, and <code class="inline">vectorStore</code> (test ID).</li>
      </ul>
    </div>

    <div id="testing" class="card">
      <h2>Testing</h2>
      <ol class="step-list">
        <li>Upload the provided sample policy DOCX to the watched SharePoint folder.</li>
        <li>Confirm the Power Automate run succeeds and the Azure job starts.</li>
        <li>Check the vector store for the new/updated file metadata.</li>
        <li>Verify that iSPoC can query the updated documents immediately.</li>
      </ol>
      <p class="muted"><strong>Note:</strong> The pipeline has been tested locally with 81 policy documents and 28 guide documents.</p>
    </div>

    <div id="next-steps" class="card">
      <h2>Next steps (switch to production)</h2>
      <ol class="step-list">
        <li>In your Azure Container Apps job secrets, remove <code class="inline">TEST_VECTOR_STORE_ID</code> and add <code class="inline">VECTOR_STORE_ID</code> with your production vector store ID.</li>
        <li>Turn on the production Power Automate flow.</li>
        <li>Keep notifications enabled for monitoring.</li>
      </ol>
      <div class="callout">
        <strong>Easy Transition:</strong> The scripts automatically use <code class="inline">TEST_VECTOR_STORE_ID</code> first, then fall back to <code class="inline">VECTOR_STORE_ID</code>. To switch from test to production, simply change which environment variable you set - no code changes needed!
      </div>
    </div>
  </div>
</body>
</html>
